@page "/journal"
@using Journal_Entry.Components.Services
@using Journal_Entry.Components.Models
@using Markdig
@inject JournalService JournalService
@inject IJSRuntime JS

<h1>✏️ Write Today's Journal</h1>

<div class="mb-3">
    <input type="text" @bind="entry.Title" placeholder="Title" class="form-control mb-2" />
    <textarea @bind="entry.Content" placeholder="Write in Markdown..." class="form-control mb-2"></textarea>

    <select @bind="entry.PrimaryMood" class="form-control mb-2">
        <option>Happy</option>
        <option>Neutral</option>
        <option>Sad</option>
        <option>Excited</option>
        <option>Calm</option>
    </select>

    <label>Secondary Moods (up to 2, comma-separated)</label>
    <input type="text" @bind="secondaryMoods" class="form-control mb-2" placeholder="e.g. Excited, Calm" />

    <label>Tags (comma-separated)</label>
    <input type="text" @bind="tags" class="form-control mb-2" placeholder="e.g. work, health" />

    <button class="btn btn-primary" @onclick="SaveEntry">Save Entry</button>
</div>

<hr />

<h3>Past Entries</h3>
@foreach (var e in entries.OrderByDescending(x => x.CreatedAt))
{
    <div class="entry-card mb-2 p-2 border rounded">
        <strong>@e.CreatedAt: @e.Title</strong>
        <p>@((MarkupString)Markdown.ToHtml(e.Content ?? ""))</p>
        <small>
            Mood: @e.PrimaryMood
            @if (e.SecondaryMoods?.Any() ?? false)
            {
                <text>| Secondary: @string.Join(",", e.SecondaryMoods)</text>
            }
            | Tags: @string.Join(",", e.Tags ?? new List<string>())
        </small>
        <div class="mt-1">
            <button class="btn btn-sm btn-warning me-1" @onclick="() => EditEntry(e)">Edit</button>
            <button class="btn btn-sm btn-danger" @onclick="() => DeleteEntry(e.Id)">Delete</button>
        </div>
    </div>
}

@code {
    private JournalEntry entry = new();
    private List<JournalEntry> entries = new();
    private string secondaryMoods = "";
    private string tags = "";

    protected override async Task OnInitializedAsync()
    {
        var todayEntry = await JournalService.GetEntryByDateAsync(DateTime.Today);
        if (todayEntry != null) entry = todayEntry;

        entries = await JournalService.GetAllEntriesAsync();
    }

    private async Task SaveEntry()
    {
        entry.SecondaryMoods = secondaryMoods.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                             .Select(s => s.Trim()).Take(2).ToList();
        entry.Tags = tags.Split(',', StringSplitOptions.RemoveEmptyEntries)
                         .Select(s => s.Trim()).ToList();

        entry.CreatedAt = entry.CreatedAt == default ? DateTime.Now : entry.CreatedAt;

        await JournalService.SaveEntryAsync(entry);

        entry = new JournalEntry();
        secondaryMoods = "";
        tags = "";

        entries = await JournalService.GetAllEntriesAsync();
    }

    private void EditEntry(JournalEntry e)
    {
        entry = e;
        secondaryMoods = string.Join(", ", e.SecondaryMoods ?? new List<string>());
        tags = string.Join(", ", e.Tags ?? new List<string>());
    }

    private async Task DeleteEntry(int id)
    {
        await JournalService.DeleteEntryAsync(id);
        entries = await JournalService.GetAllEntriesAsync();
    }
}


