@page "/dashboard"
@using Journal_Entry.Components.Models
@using Journal_Entry.Components.Services
@inject JournalService JournalService


<h1>📊 Dashboard</h1>

<div class="row mb-3">
    <div class="col">
        <strong>Current Streak:</strong> @currentStreak days
    </div>
    <div class="col">
        <strong>Longest Streak:</strong> @longestStreak days
    </div>
    <div class="col">
        <strong>Total Entries:</strong> @entries.Count
    </div>
</div>

<div>
    <h3>Mood Distribution</h3>
    @foreach (var kv in moodDistribution)
    {
        <div>@kv.Key: @kv.Value</div>
    }
</div>

@code {
    private List<JournalEntry> entries = new();
    private int currentStreak = 0;
    private int longestStreak = 0;
    private Dictionary<string, int> moodDistribution = new();

    protected override async Task OnInitializedAsync()
    {
        entries = await JournalService.GetAllEntriesAsync();
        CalculateStreaks();
        CalculateMoodDistribution();
    }

    private void CalculateStreaks()
    {
        var ordered = entries.OrderBy(e => e.CreatedAt.Date).ToList();
        int streak = 0; int maxStreak = 0; DateTime? last = null;

        foreach (var e in ordered)
        {
            if (last == null || (e.CreatedAt.Date - last.Value.Date).Days == 1)
            { streak++; if (streak > maxStreak) maxStreak = streak; }
            else { streak = 1; }
            last = e.CreatedAt;
        }
        currentStreak = streak;
        longestStreak = maxStreak;
    }

    private void CalculateMoodDistribution()
    {
        moodDistribution = entries.GroupBy(e => e.PrimaryMood)
                                  .ToDictionary(g => g.Key, g => g.Count());
    }
}
